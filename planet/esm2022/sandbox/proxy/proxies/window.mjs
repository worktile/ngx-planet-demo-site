import { hasOwnProp, createFakeObject, bind, isInvalidSetAccessor, isNonWriteableValue, isInvalidGetAccessor } from './common';
import { PLANET_SANDBOX_WINDOW_WHITELIST, SANDBOX_INSTANCE, WINDOW_BIND_FN } from '../../constants';
import { isFunction } from '../../../helpers';
const esGlobalFunctions = ('eval,isFinite,isNaN,parseFloat,parseInt,' +
    // URL handling functions
    'decodeURI,decodeURIComponent,encodeURI,encodeURIComponent,' +
    // Constructor properties of the global object
    'Array,ArrayBuffer,BigInt,BigInt64Array,BigUint64Array,Boolean,DataView,Date,Error,EvalError,' +
    'FinalizationRegistry,Float32Array,Float64Array,Function,Int8Array,Int16Array,Int32Array,Map,Number,' +
    'Object,Promise,Proxy,RangeError,ReferenceError,RegExp,Set,SharedArrayBuffer,String,Symbol,SyntaxError,' +
    'TypeError,Uint8Array,Uint8ClampedArray,Uint16Array,Uint32Array,URIError,WeakMap,WeakRef,WeakSet,' +
    // Other Properties of the Global Object
    'Atomics,JSON,Math,Reflect').split(',');
const whitelistVariables = PLANET_SANDBOX_WINDOW_WHITELIST || [];
function isConstructor(fn) {
    const fp = fn.prototype;
    const hasConstructor = fp && fp.constructor === fn && Object.getOwnPropertyNames(fp).length > 1;
    const functionStr = !hasConstructor && fn.toString();
    return hasConstructor || /^function\s+[A-Z]/.test(functionStr) || /^class\b/.test(functionStr);
}
const unscopables = {
    undefined: true,
    Array: true,
    Object: true,
    String: true,
    Boolean: true,
    Math: true,
    Number: true,
    Symbol: true,
    parseFloat: true,
    Float32Array: true
};
export class ProxyWindow {
    constructor(sandbox) {
        this.sandbox = sandbox;
        this.definedVariables = new Set();
    }
    createGetter() {
        return (target, key, receiver) => {
            if (key === Symbol.unscopables) {
                return unscopables;
            }
            if (key === SANDBOX_INSTANCE) {
                return this.sandbox;
            }
            let value = null;
            if (whitelistVariables.includes(key)) {
                return Reflect.get(window, key);
            }
            else {
                value = hasOwnProp(target, key) ? Reflect.get(target, key, receiver) : Reflect.get(window, key);
            }
            if (isFunction(value)) {
                if (esGlobalFunctions.includes(key) ||
                    whitelistVariables.includes(key) ||
                    this.sandbox.rewriteVariables.includes(key) ||
                    this.definedVariables.has(key) ||
                    isConstructor(value)) {
                    return value;
                }
                else {
                    const newValue = hasOwnProp(value, WINDOW_BIND_FN) ? value[WINDOW_BIND_FN] : bind(value, window);
                    const desc = Object.getOwnPropertyDescriptor(target, key);
                    if (isNonWriteableValue(desc)) {
                        return value;
                    }
                    if (isInvalidGetAccessor(desc)) {
                        return undefined;
                    }
                    value[WINDOW_BIND_FN] = newValue;
                    return newValue;
                }
            }
            else {
                return value;
            }
        };
    }
    createSetter() {
        return (target, key, value, receiver) => {
            const desc = Object.getOwnPropertyDescriptor(whitelistVariables.includes(key) ? window : receiver ? receiver : target, key);
            if (desc && isNonWriteableValue(desc)) {
                if (!Object.is(value, desc.value)) {
                    return false;
                }
                else {
                    return true;
                }
            }
            if (isInvalidSetAccessor(desc)) {
                return false;
            }
            if (whitelistVariables.includes(key)) {
                return Reflect.set(window, key, value);
            }
            else {
                const success = Reflect.set(target, key, value, receiver);
                if (success) {
                    if (this.sandbox.running) {
                        this.definedVariables.add(key);
                    }
                }
                return success;
            }
        };
    }
    createDefineProperty() {
        return (target, p, descriptor) => {
            if (whitelistVariables.includes(p)) {
                return Reflect.defineProperty(window, p, descriptor);
            }
            else {
                const success = Reflect.defineProperty(target, p, descriptor);
                if (this.sandbox.running && success) {
                    this.definedVariables.add(p);
                }
                return success;
            }
        };
    }
    createDeleteProperty() {
        return (target, p) => {
            if (hasOwnProp(target, p)) {
                delete target[p];
                if (this.sandbox.running && this.definedVariables.has(p)) {
                    this.definedVariables.delete(p);
                }
            }
            return true;
        };
    }
    createHas() {
        return (_target, key) => {
            return !whitelistVariables.includes(key);
        };
    }
    create() {
        const fakeWindow = createFakeObject(window, this.sandbox.rewriteVariables);
        const baseHandlers = {
            get: this.createGetter(),
            set: this.createSetter(),
            defineProperty: this.createDefineProperty(),
            deleteProperty: this.createDeleteProperty()
        };
        const proxy = new Proxy(fakeWindow, {
            ...baseHandlers,
            has: this.createHas()
        });
        const subProxy = new Proxy(fakeWindow, baseHandlers);
        proxy.self = subProxy;
        proxy.window = subProxy;
        proxy.globalThis = subProxy;
        proxy.top = window.top === window ? subProxy : window.top;
        proxy.parent = window.parent === window ? subProxy : window.top;
        return proxy;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2luZG93LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vcGFja2FnZXMvcGxhbmV0L3NyYy9zYW5kYm94L3Byb3h5L3Byb3hpZXMvd2luZG93LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDSCxVQUFVLEVBQ1YsZ0JBQWdCLEVBQ2hCLElBQUksRUFDSixvQkFBb0IsRUFDcEIsbUJBQW1CLEVBQ25CLG9CQUFvQixFQUN2QixNQUFNLFVBQVUsQ0FBQztBQUNsQixPQUFPLEVBQUUsK0JBQStCLEVBQUUsZ0JBQWdCLEVBQUUsY0FBYyxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDcEcsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBRzlDLE1BQU0saUJBQWlCLEdBQWtCLENBQ3JDLDBDQUEwQztJQUMxQyx5QkFBeUI7SUFDekIsNERBQTREO0lBQzVELDhDQUE4QztJQUM5Qyw4RkFBOEY7SUFDOUYscUdBQXFHO0lBQ3JHLHdHQUF3RztJQUN4RyxrR0FBa0c7SUFDbEcsd0NBQXdDO0lBQ3hDLDJCQUEyQixDQUM5QixDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUViLE1BQU0sa0JBQWtCLEdBQUcsK0JBQStCLElBQUksRUFBRSxDQUFDO0FBRWpFLFNBQVMsYUFBYSxDQUFDLEVBQW9DO0lBQ3ZELE1BQU0sRUFBRSxHQUFHLEVBQUUsQ0FBQyxTQUFTLENBQUM7SUFDeEIsTUFBTSxjQUFjLEdBQUcsRUFBRSxJQUFJLEVBQUUsQ0FBQyxXQUFXLEtBQUssRUFBRSxJQUFJLE1BQU0sQ0FBQyxtQkFBbUIsQ0FBQyxFQUFFLENBQUMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO0lBQ2hHLE1BQU0sV0FBVyxHQUFHLENBQUMsY0FBYyxJQUFJLEVBQUUsQ0FBQyxRQUFRLEVBQUUsQ0FBQztJQUNyRCxPQUFPLGNBQWMsSUFBSSxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsV0FBcUIsQ0FB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Q2pCLENBQUM7Q0FDSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gICAgaGFzT3duUHJvcCxcbiAgICBjcmVhdGVGYWtlT2JqZWN0LFxuICAgIGJpbmQsXG4gICAgaXNJbnZhbGlkU2V0QWNjZXNzb3IsXG4gICAgaXNOb25Xcml0ZWFibGVWYWx1ZSxcbiAgICBpc0ludmFsaWRHZXRBY2Nlc3NvclxufSBmcm9tICcuL2NvbW1vbic7XG5pbXBvcnQgeyBQTEFORVRfU0FOREJPWF9XSU5ET1dfV0hJVEVMSVNULCBTQU5EQk9YX0lOU1RBTkNFLCBXSU5ET1dfQklORF9GTiB9IGZyb20gJy4uLy4uL2NvbnN0YW50cyc7XG5pbXBvcnQgeyBpc0Z1bmN0aW9uIH0gZnJvbSAnLi4vLi4vLi4vaGVscGVycyc7XG5pbXBvcnQgeyBQcm94eVNhbmRib3hJbnN0YW5jZSB9IGZyb20gJy4uL3R5cGVzJztcblxuY29uc3QgZXNHbG9iYWxGdW5jdGlvbnM6IFByb3BlcnR5S2V5W10gPSAoXG4gICAgJ2V2YWwsaXNGaW5pdGUsaXNOYU4scGFyc2VGbG9hdCxwYXJzZUludCwnICtcbiAgICAvLyBVUkwgaGFuZGxpbmcgZnVuY3Rpb25zXG4gICAgJ2RlY29kZVVSSSxkZWNvZGVVUklDb21wb25lbnQsZW5jb2RlVVJJLGVuY29kZVVSSUNvbXBvbmVudCwnICtcbiAgICAvLyBDb25zdHJ1Y3RvciBwcm9wZXJ0aWVzIG9mIHRoZSBnbG9iYWwgb2JqZWN0XG4gICAgJ0FycmF5LEFycmF5QnVmZmVyLEJpZ0ludCxCaWdJbnQ2NEFycmF5LEJpZ1VpbnQ2NEFycmF5LEJvb2xlYW4sRGF0YVZpZXcsRGF0ZSxFcnJvcixFdmFsRXJyb3IsJyArXG4gICAgJ0ZpbmFsaXphdGlvblJlZ2lzdHJ5LEZsb2F0MzJBcnJheSxGbG9hdDY0QXJyYXksRnVuY3Rpb24sSW50OEFycmF5LEludDE2QXJyYXksSW50MzJBcnJheSxNYXAsTnVtYmVyLCcgK1xuICAgICdPYmplY3QsUHJvbWlzZSxQcm94eSxSYW5nZUVycm9yLFJlZmVyZW5jZUVycm9yLFJlZ0V4cCxTZXQsU2hhcmVkQXJyYXlCdWZmZXIsU3RyaW5nLFN5bWJvbCxTeW50YXhFcnJvciwnICtcbiAgICAnVHlwZUVycm9yLFVpbnQ4QXJyYXksVWludDhDbGFtcGVkQXJyYXksVWludDE2QXJyYXksVWludDMyQXJyYXksVVJJRXJyb3IsV2Vha01hcCxXZWFrUmVmLFdlYWtTZXQsJyArXG4gICAgLy8gT3RoZXIgUHJvcGVydGllcyBvZiB0aGUgR2xvYmFsIE9iamVjdFxuICAgICdBdG9taWNzLEpTT04sTWF0aCxSZWZsZWN0J1xuKS5zcGxpdCgnLCcpO1xuXG5jb25zdCB3aGl0ZWxpc3RWYXJpYWJsZXMgPSBQTEFORVRfU0FOREJPWF9XSU5ET1dfV0hJVEVMSVNUIHx8IFtdO1xuXG5mdW5jdGlvbiBpc0NvbnN0cnVjdG9yKGZuOiAoKSA9PiB2b2lkIHwgRnVuY3Rpb25Db25zdHJ1Y3Rvcikge1xuICAgIGNvbnN0IGZwID0gZm4ucHJvdG90eXBlO1xuICAgIGNvbnN0IGhhc0NvbnN0cnVjdG9yID0gZnAgJiYgZnAuY29uc3RydWN0b3IgPT09IGZuICYmIE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKGZwKS5sZW5ndGggPiAxO1xuICAgIGNvbnN0IGZ1bmN0aW9uU3RyID0gIWhhc0NvbnN0cnVjdG9yICYmIGZuLnRvU3RyaW5nKCk7XG4gICAgcmV0dXJuIGhhc0NvbnN0cnVjdG9yIHx8IC9eZnVuY3Rpb25cXHMrW0EtWl0vLnRlc3QoZnVuY3Rpb25TdHIgYXMgc3RyaW5nKSB8fCAvXmNsYXNzXFxiLy50ZXN0KGZ1bmN0aW9uU3RyIGFzIHN0cmluZyk7XG59XG5cbmNvbnN0IHVuc2NvcGFibGVzID0ge1xuICAgIHVuZGVmaW5lZDogdHJ1ZSxcbiAgICBBcnJheTogdHJ1ZSxcbiAgICBPYmplY3Q6IHRydWUsXG4gICAgU3RyaW5nOiB0cnVlLFxuICAgIEJvb2xlYW46IHRydWUsXG4gICAgTWF0aDogdHJ1ZSxcbiAgICBOdW1iZXI6IHRydWUsXG4gICAgU3ltYm9sOiB0cnVlLFxuICAgIHBhcnNlRmxvYXQ6IHRydWUsXG4gICAgRmxvYXQzMkFycmF5OiB0cnVlXG59O1xuXG5leHBvcnQgY2xhc3MgUHJveHlXaW5kb3cge1xuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgc2FuZGJveDogUHJveHlTYW5kYm94SW5zdGFuY2UpIHt9XG5cbiAgICBwcml2YXRlIGRlZmluZWRWYXJpYWJsZXMgPSBuZXcgU2V0KCk7XG5cbiAgICBwcml2YXRlIGNyZWF0ZUdldHRlcigpIHtcbiAgICAgICAgcmV0dXJuICh0YXJnZXQ6IFdpbmRvdywga2V5OiBQcm9wZXJ0eUtleSwgcmVjZWl2ZXI6IGFueSkgPT4ge1xuICAgICAgICAgICAgaWYgKGtleSA9PT0gU3ltYm9sLnVuc2NvcGFibGVzKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHVuc2NvcGFibGVzO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGtleSA9PT0gU0FOREJPWF9JTlNUQU5DRSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnNhbmRib3g7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBsZXQgdmFsdWUgPSBudWxsO1xuICAgICAgICAgICAgaWYgKHdoaXRlbGlzdFZhcmlhYmxlcy5pbmNsdWRlcyhrZXkpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIFJlZmxlY3QuZ2V0KHdpbmRvdywga2V5KTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdmFsdWUgPSBoYXNPd25Qcm9wKHRhcmdldCwga2V5KSA/IFJlZmxlY3QuZ2V0KHRhcmdldCwga2V5LCByZWNlaXZlcikgOiBSZWZsZWN0LmdldCh3aW5kb3csIGtleSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoaXNGdW5jdGlvbih2YWx1ZSkpIHtcbiAgICAgICAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAgICAgICAgIGVzR2xvYmFsRnVuY3Rpb25zLmluY2x1ZGVzKGtleSkgfHxcbiAgICAgICAgICAgICAgICAgICAgd2hpdGVsaXN0VmFyaWFibGVzLmluY2x1ZGVzKGtleSkgfHxcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zYW5kYm94LnJld3JpdGVWYXJpYWJsZXMuaW5jbHVkZXMoa2V5KSB8fFxuICAgICAgICAgICAgICAgICAgICB0aGlzLmRlZmluZWRWYXJpYWJsZXMuaGFzKGtleSkgfHxcbiAgICAgICAgICAgICAgICAgICAgaXNDb25zdHJ1Y3Rvcih2YWx1ZSlcbiAgICAgICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IG5ld1ZhbHVlID0gaGFzT3duUHJvcCh2YWx1ZSwgV0lORE9XX0JJTkRfRk4pID8gdmFsdWVbV0lORE9XX0JJTkRfRk5dIDogYmluZCh2YWx1ZSwgd2luZG93KTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodGFyZ2V0LCBrZXkpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoaXNOb25Xcml0ZWFibGVWYWx1ZShkZXNjKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChpc0ludmFsaWRHZXRBY2Nlc3NvcihkZXNjKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB2YWx1ZVtXSU5ET1dfQklORF9GTl0gPSBuZXdWYWx1ZTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ld1ZhbHVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHByaXZhdGUgY3JlYXRlU2V0dGVyKCkge1xuICAgICAgICByZXR1cm4gKHRhcmdldDogV2luZG93LCBrZXk6IFByb3BlcnR5S2V5LCB2YWx1ZTogdW5rbm93biwgcmVjZWl2ZXI6IGFueSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgZGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoXG4gICAgICAgICAgICAgICAgd2hpdGVsaXN0VmFyaWFibGVzLmluY2x1ZGVzKGtleSkgPyB3aW5kb3cgOiByZWNlaXZlciA/IHJlY2VpdmVyIDogdGFyZ2V0LFxuICAgICAgICAgICAgICAgIGtleVxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIGlmIChkZXNjICYmIGlzTm9uV3JpdGVhYmxlVmFsdWUoZGVzYykpIHtcbiAgICAgICAgICAgICAgICBpZiAoIU9iamVjdC5pcyh2YWx1ZSwgZGVzYy52YWx1ZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChpc0ludmFsaWRTZXRBY2Nlc3NvcihkZXNjKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICh3aGl0ZWxpc3RWYXJpYWJsZXMuaW5jbHVkZXMoa2V5KSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBSZWZsZWN0LnNldCh3aW5kb3csIGtleSwgdmFsdWUpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjb25zdCBzdWNjZXNzID0gUmVmbGVjdC5zZXQodGFyZ2V0LCBrZXksIHZhbHVlLCByZWNlaXZlcik7XG4gICAgICAgICAgICAgICAgaWYgKHN1Y2Nlc3MpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuc2FuZGJveC5ydW5uaW5nKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRlZmluZWRWYXJpYWJsZXMuYWRkKGtleSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIHN1Y2Nlc3M7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjcmVhdGVEZWZpbmVQcm9wZXJ0eSgpIHtcbiAgICAgICAgcmV0dXJuICh0YXJnZXQ6IFdpbmRvdywgcDogUHJvcGVydHlLZXksIGRlc2NyaXB0b3I6IFByb3BlcnR5RGVzY3JpcHRvcikgPT4ge1xuICAgICAgICAgICAgaWYgKHdoaXRlbGlzdFZhcmlhYmxlcy5pbmNsdWRlcyhwKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBSZWZsZWN0LmRlZmluZVByb3BlcnR5KHdpbmRvdywgcCwgZGVzY3JpcHRvcik7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGNvbnN0IHN1Y2Nlc3MgPSBSZWZsZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwgcCwgZGVzY3JpcHRvcik7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuc2FuZGJveC5ydW5uaW5nICYmIHN1Y2Nlc3MpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kZWZpbmVkVmFyaWFibGVzLmFkZChwKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIHN1Y2Nlc3M7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjcmVhdGVEZWxldGVQcm9wZXJ0eSgpIHtcbiAgICAgICAgcmV0dXJuICh0YXJnZXQ6IFdpbmRvdywgcDogUHJvcGVydHlLZXkpID0+IHtcbiAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wKHRhcmdldCwgcCkpIHtcbiAgICAgICAgICAgICAgICBkZWxldGUgKHRhcmdldCBhcyBhbnkpW3BdO1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLnNhbmRib3gucnVubmluZyAmJiB0aGlzLmRlZmluZWRWYXJpYWJsZXMuaGFzKHApKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZGVmaW5lZFZhcmlhYmxlcy5kZWxldGUocCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjcmVhdGVIYXMoKSB7XG4gICAgICAgIHJldHVybiAoX3RhcmdldDogV2luZG93LCBrZXk6IFByb3BlcnR5S2V5KSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gIXdoaXRlbGlzdFZhcmlhYmxlcy5pbmNsdWRlcyhrZXkpO1xuICAgICAgICB9O1xuICAgIH1cblxuICAgIGNyZWF0ZSgpIHtcbiAgICAgICAgY29uc3QgZmFrZVdpbmRvdyA9IGNyZWF0ZUZha2VPYmplY3Qod2luZG93LCB0aGlzLnNhbmRib3gucmV3cml0ZVZhcmlhYmxlcyk7XG4gICAgICAgIGNvbnN0IGJhc2VIYW5kbGVycyA9IHtcbiAgICAgICAgICAgIGdldDogdGhpcy5jcmVhdGVHZXR0ZXIoKSxcbiAgICAgICAgICAgIHNldDogdGhpcy5jcmVhdGVTZXR0ZXIoKSxcbiAgICAgICAgICAgIGRlZmluZVByb3BlcnR5OiB0aGlzLmNyZWF0ZURlZmluZVByb3BlcnR5KCksXG4gICAgICAgICAgICBkZWxldGVQcm9wZXJ0eTogdGhpcy5jcmVhdGVEZWxldGVQcm9wZXJ0eSgpXG4gICAgICAgIH07XG4gICAgICAgIGNvbnN0IHByb3h5ID0gbmV3IFByb3h5KGZha2VXaW5kb3csIHtcbiAgICAgICAgICAgIC4uLmJhc2VIYW5kbGVycyxcbiAgICAgICAgICAgIGhhczogdGhpcy5jcmVhdGVIYXMoKVxuICAgICAgICB9KTtcbiAgICAgICAgY29uc3Qgc3ViUHJveHkgPSBuZXcgUHJveHkoZmFrZVdpbmRvdywgYmFzZUhhbmRsZXJzKTtcbiAgICAgICAgcHJveHkuc2VsZiA9IHN1YlByb3h5O1xuICAgICAgICBwcm94eS53aW5kb3cgPSBzdWJQcm94eTtcbiAgICAgICAgcHJveHkuZ2xvYmFsVGhpcyA9IHN1YlByb3h5O1xuICAgICAgICBwcm94eS50b3AgPSB3aW5kb3cudG9wID09PSB3aW5kb3cgPyBzdWJQcm94eSA6IHdpbmRvdy50b3A7XG4gICAgICAgIHByb3h5LnBhcmVudCA9IHdpbmRvdy5wYXJlbnQgPT09IHdpbmRvdyA/IHN1YlByb3h5IDogd2luZG93LnRvcDtcbiAgICAgICAgcmV0dXJuIHByb3h5O1xuICAgIH1cbn1cbiJdfQ==